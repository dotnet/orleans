<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Cloud Deployment | Microsoft Orleans Website </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Cloud Deployment | Microsoft Orleans Website ">
    <meta name="generator" content="docfx 2.10.1.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    <meta property="docfx:rel" content="../">
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../Images/logo-light.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items"></div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
              <h1 id="cloud-deployment">Cloud Deployment</h1>
              
<h2 id="deploying-orleans-to-windows-azure">Deploying Orleans to Windows Azure</h2>
<p>This walkthrough shows the steps required to deploy the sample created in the  <a href="Front-Ends-for-Orleans-Services.html">Front Ends for Orleans Services</a> to Windows Azure Cloud Services.</p>
<p>In Azure, one or more worker roles will be used to host the Orleans silos, and an Azure web role will act as the presentation layer for the application and client to the application grains running in the Orleans silos.</p>
<p>The same grain interfaces and implementation can run on both Windows Server and Windows Azure, so no special considerations are needed in order to be able to run your application in a Windows Azure hosting environment.</p>
<p>The  <a href="https://github.com/dotnet/orleans/tree/master/Samples/AzureWebSample">Azure Web Sample</a> sample app provides a working example of how to run a web application with supporting Orleans silo cluster backend in an Azure hosted service, and the details are described below.</p>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>The following prerequisites are required:</p>
<ul>
<li>Visual Studio 2013 or 2015</li>
<li><a href="http://azure.microsoft.com/en-us/downloads/">Windows Azure SDK v2.4 or higher</a></li>
</ul>
<p>For more info on installing and working with Windows Azure in general, see the Microsoft Developer Network (MSDN) web site: (<a href="http://msdn.microsoft.com/en-us/windowsazure/">http://msdn.microsoft.com/en-us/windowsazure/</a>)</p>
<h2 id="create-azure-worker-role-for-orleans-silos">Create Azure Worker Role for Orleans Silos</h2>
<p>Right click on your solution, and select &#39;Add | New Project...&#39;.</p>
<p>Choose the &#39;Windows Azure Cloud Service&#39; project template:</p>
<p><img src="../Images/AzureTutorial1.PNG" alt=""></p>
<p>When prompted, select a new &#39;Worker Role&#39; to add to the project.
This will be used to host the Orleans Silos:</p>
<p><img src="../Images/AzureTutorial2.PNG" alt=""></p>
<h2 id="add-project-references-for-orleans-silo-binaries">Add project references for Orleans Silo binaries</h2>
<p>Add references to the <code>OrleansAzureSilo</code> project for the required Orleans server library files.
Copies of these files can be found in the <em>.\Binaries\OrleansServer</em> folder under the Orleans SDK.</p>
<ul>
<li>Orleans.dll</li>
<li>OrleansAzureUtils.dll</li>
<li>OrleansRuntime.dll</li>
<li>OrleansProviders.dll (Only required if you your grains use the <a href="Declarative-Persistence.html">Declarative Persistence</a> functionality.)</li>
</ul>
<p>Note: All of these references MUST have <em>Copy Local = &#39;True&#39;</em> settings to ensure the necessary library DLLs get copied into the <code>OrleansAzureSilo</code> project output directory.</p>
<p><img src="../Images/AzureTutorial3.PNG" alt=""></p>
<h2 id="configure-azure-worker-role-for-orleans-silos">Configure Azure Worker Role for Orleans Silos</h2>
<p>The Worker Role initialization class is a normal Azure worker role - it needs to inherit from the usual <code>Microsoft.WindowsAzure.ServiceRuntime.RoleEntryPoint</code> base class.</p>
<p>The worker role initialization class needs to create an instance of <code>Orleans.Runtime.Host.AzureSilo</code> class, and call the appropriate <code>Start</code>/<code>Run</code>/<code>Stop</code> functions in the appropriate places:</p>
<pre><code class="lang-csharp">public class WorkerRole : RoleEntryPoint
{
    AzureSilo silo;

    public override bool OnStart()
    {
        // Do other silo initialization – for example: Azure diagnostics, etc

        return base.OnStart();
    }

    public override void OnStop()
    {
        silo.Stop();
        base.OnStop();
    }

    public override void Run()
    {
        var config = AzureSilo.DefaultConfiguration();
        config.AddMemoryStorageProvider();
        config.AddAzureTableStorageProvider(&quot;AzureStore&quot;, RoleEnvironment.GetConfigurationSettingValue(&quot;DataConnectionString&quot;));

        // Configure storage providers

        silo = new AzureSilo();
        bool ok = silo.Start(config);

        silo.Run(); // Call will block until silo is shutdown
    }
}
</code></pre><p>It is IMPORTANT to start the silo not in OnStart but in Run. Azure may not have the firewalls open yet (on the remote silos) at the OnStart phase.</p>
<p>Then, in the <code>ServiceDefinition.csdef</code> file for this role, add some required configuration items used by the Orleans Azure hosting library to the WorkerRole configuration:</p>
<ul>
<li>Add a <code>ConfigurationSettings</code> declaration named &#39;DataConnectionString&#39;. This is the Azure storage location where Orleans Azure hosting library will place / look for its silo instance table.</li>
<li>Add an <code>InternalEndpoint</code> declaration for a TCP endpoint named &#39;OrleansSiloEndpoint&#39;</li>
<li>Add an <code>InternalEndpoint</code> declaration for a TCP endpoint named &#39;OrleansProxyEndpoint&#39;</li>
</ul>
<pre><code class="lang-xml">&lt;ServiceDefinition ...&gt;
    &lt;WorkerRole name=&quot;OrleansAzureSilos&quot; ...&gt;
        ...
        &lt;ConfigurationSettings&gt;
            &lt;Setting name=&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; /&gt;
            &lt;Setting name=&quot;DataConnectionString&quot; /&gt;
        &lt;/ConfigurationSettings&gt;
        &lt;Endpoints&gt;
            &lt;InternalEndpoint name=&quot;OrleansSiloEndpoint&quot; protocol=&quot;tcp&quot; port=&quot;11111&quot; /&gt;
            &lt;InternalEndpoint name=&quot;OrleansProxyEndpoint&quot; protocol=&quot;tcp&quot; port=&quot;30000&quot; /&gt;
        &lt;/Endpoints&gt;
        ...
    &lt;/WorkerRole&gt;
    ...
&lt;/ServiceDefinition&gt;
</code></pre><p>In the <em>ServiceConfiguration.cscfg</em> file for this role, add some required configuration items used by the Orleans Azure hosting library:</p>
<p>Add a <code>ConfigurationSettings</code> definition for &#39;DataConnectionString&#39;</p>
<p>This will be a normal Azure storage connection – either for the development storage emulator (only valid if running locally), or a full Azure storage account connection string for cloud-storage.</p>
<p>In general, this connection string is likely to use the same configuration values as the <code>Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</code> diagnostics connection string setting, but is not required to. Be careful to not mix up Azure storage and local storage. This can cause deployments to not work.</p>
<p>See the <a href="http://azure.microsoft.com/en-us/documentation/articles/storage-configure-connection-string/">Configure Azure Storage Connection Strings</a> for more information.</p>
<p>For example, to use local Developer Storage emulator (for local testing only)</p>
<pre><code class="lang-xml">&lt;ConfigurationSettings&gt;
    &lt;Setting name=&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; value=&quot;UseDevelopmentStorage=true&quot; /&gt;
    &lt;Setting name=&quot;DataConnectionString&quot; value=&quot;UseDevelopmentStorage=true&quot; /&gt;
&lt;/ConfigurationSettings&gt;
</code></pre><p>Or using an Azure cloud storage account:</p>
<pre><code class="lang-xml">&lt;ConfigurationSettings&gt;
    &lt;Setting name=&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; value=&quot;DefaultEndpointsProtocol=https;AccountName=MyAccount;AccountKey=MyKey&quot; /&gt;
    &lt;Setting name=&quot;DataConnectionString&quot; value=&quot;DefaultEndpointsProtocol=https;AccountName=MyAccount;AccountKey=MyKey&quot; /&gt;
&lt;/ConfigurationSettings&gt;
</code></pre><h2 id="changing-dataconnectionstring">Changing DataConnectionString</h2>
<p>The &quot;DataConnectionString&quot; setting in <code>ServiceDefinition.csdef</code> is the default name use by the Orleans silo for the Azure table account connection string that will be used for Orleans system tables such as <code>OrleanSiloInstances</code>.</p>
<p>If you wish to use a different setting name for this value, then in the silo role initialization code set the property <code>OrleansAzureSilo.DataConnectionConfigurationSettingName</code> before the call to <code>OrleansAzureSilo.Start(...)</code></p>
<h2 id="add-your-grain-binaries-to-azure-worker-role-for-orleans-silos">Add your grain binaries to Azure Worker Role for Orleans Silos</h2>
<p>Add the grain interfaces DLL and implementation classes DLL for the grains to be hosted in the Azure silo into the <code>OrleansAzureSilo</code> project, along with any supporting libraries those grains need.</p>
<p>Note: You MUST ensure that all the referenced binaries are copied into the <code>OrleansAzureSilo</code> project output directory, to ensure they get picked up by the Azure packaging tools.</p>
<h2 id="running-orleans-client-as-azure-web-role">Running Orleans Client as Azure Web Role</h2>
<p>The user interface / presentation layer for your application will usually run as a Web Role in Azure.</p>
<p>The <code>Orleans.Runtime.Host.AzureClient</code> utility class is the main mechanism for bootstrapping connection to the Orleans silo worker roles from an Azure Web Role.
A few additional configuration steps are needed to make the <code>AzureClient</code> utility class work – see below for details.</p>
<h3 id="create-azure-web-role-for-orleans-client">Create Azure Web Role for Orleans Client</h3>
<p>Any type of web role can be used as an Orleans client, and there are no specific naming requirements or conventions for this project.</p>
<p>Add a web role to the solution using the existing web application project that we created in the Front Ends for Orleans Services tutorial.</p>
<p>Add project references for Orleans Client binaries.
Add references to the web role project for the required Orleans client library files.
Copies of these files can be found in either  <em>SDK-ROOT\Samples\References</em> or  <em>SDK-ROOT\Binaries\OrleansClient</em> directories.</p>
<ul>
<li>Orleans.dll</li>
<li>OrleansAzureUtils.dll</li>
</ul>
<p>Note: All of these references MUST have <em>Copy Local = &#39;True&#39;</em> settings to ensure the necessary library DLLs get copied into the web role project output directory.</p>
<h3 id="configure-azure-web-role-to-be-an-orleans-client">Configure Azure Web Role to be an Orleans Client</h3>
<p>In the <code>ServiceDefinition.csdef</code> file for this web role, add some required configuration items used by the Orleans Azure hosting library:</p>
<ul>
<li>Add a <code>ConfigurationSettings</code> declaration named &#39;DataConnectionString&#39;.
This is the Azure storage location where Orleans Azure hosting library will place / look for its silo instance table.</li>
<li>In addition, a http/s <code>InputEndpoint</code> will also need to be declared, just as for any other Azure web role config.</li>
</ul>
<pre><code class="lang-xml">&lt;ServiceDefinition ...&gt;
&lt;WebRole name=&quot;MyWebRole&quot; ...&gt;
    ...
    &lt;Sites&gt;
      &lt;Site name=&quot;Web&quot;&gt;
        &lt;Bindings&gt;
            &lt;Binding name=&quot;Endpoint1&quot; endpointName=&quot;Endpoint1&quot; /&gt;
        &lt;/Bindings&gt;
      &lt;/Site&gt;
    &lt;/Sites&gt;
    &lt;ConfigurationSettings&gt;
        &lt;Setting name=&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; /&gt;
        &lt;Setting name=&quot;DataConnectionString&quot; /&gt;
    &lt;/ConfigurationSettings&gt;
    &lt;Endpoints&gt;
        &lt;InputEndpoint name=&quot;Endpoint1&quot; protocol=&quot;http&quot; port=&quot;80&quot; /&gt;
    &lt;/Endpoints&gt;
    ...
&lt;/WebRole&gt;
...
&lt;/ServiceDefinition&gt;
</code></pre><p>In the <em>ServiceConfiguration.cscfg</em> file for this role, add some required configuration items used by the Orleans Azure hosting library:</p>
<p>Add a <code>ConfigurationSettings</code> definition for &#39;DataConnectionString&#39;.
This will be a normal Azure storage connection – either for the development storage emulator (if running locally), or a full Azure storage account connection string for cloud-storage.</p>
<p>This setting MUST match the <code>DataConnectionString</code> value used by the <code>OrleansSiloWorker</code> role in order for the client to discover and bootstrap the connection to the Orleans silos.</p>
<p>For example, to use local Developer Storage emulator (for local testing only)</p>
<pre><code class="lang-xml">&lt;ServiceConfiguration ...&gt;
&lt;Role name=&quot;OrleansWebClient&quot; ...&gt;
    ...
    &lt;ConfigurationSettings&gt;
        &lt;Setting name=&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; value=&quot;UseDevelopmentStorage=true&quot; /&gt;
        &lt;Setting name=&quot;DataConnectionString&quot; value=&quot;UseDevelopmentStorage=true&quot; /&gt;
    &lt;/ConfigurationSettings&gt;
    ...
&lt;/Role&gt;
...
&lt;/ServiceConfiguration&gt;
</code></pre><p>Or using an Azure cloud storage account:</p>
<pre><code class="lang-xml">&lt;ServiceConfiguration ...&gt;
&lt;Role name=&quot;OrleansWebClient&quot; ...&gt;
    ...
    &lt;ConfigurationSettings&gt;
        &lt;Setting name=&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; value=&quot;DefaultEndpointsProtocol=https;AccountName=MyAccount;AccountKey=MyKey&quot; /&gt;
        &lt;Setting name=&quot;DataConnectionString&quot;    value=&quot;DefaultEndpointsProtocol=https;AccountName=MyAccount;AccountKey=MyKey&quot; /&gt;
    &lt;/ConfigurationSettings&gt;
    ...
&lt;/Role&gt;
...
&lt;/ServiceConfiguration&gt;
</code></pre><h3 id="add-your-grain-interface-binaries-to-azure-web-role-for-orleans-client">Add your grain interface binaries to Azure Web Role for Orleans Client</h3>
<p>Add the grain interfaces DLL for the application grains into this web role project.</p>
<p>Access to the DLL containing the grain implementation classes should not be required by the client web role.</p>
<p>Note: You MUST ensure that all the referenced binaries for grain interfaces and the generated proxy / factory libraries are copied into the web role project output directory, to ensure they get picked up by the Azure packaging tools.</p>
<p>The grain implementation DLLs should not be required by the client and so should not be referenced by the web role.</p>
<h2 id="initialize-client-connection-to-orleans-silos">Initialize Client Connection to Orleans Silos</h2>
<p>It is recommended to bootstrap and initialize the client connection to the Orleans silo worker roles, to ensure a connection is set up before use in the <em>Global.asax</em> initialization methods.</p>
<p>Edit the configuration of the client in the <em>Global.asax.cs</em> file to use <code>AzureClient</code>.</p>
<pre><code class="lang-csharp">namespace WebApplication1
{
    public class WebApiApplication : System.Web.HttpApplication
    {
        protected void Application_Start()
        {
            ...
            var config = AzureClient.DefaultConfiguration();

            // Attempt to connect a few times to overcome transient failures and to give the silo enough 
            // time to start up when starting at the same time as the client (useful when deploying or during development).
            const int initializeAttemptsBeforeFailing = 5;

            int attempt = 0;
            while (true)
            {
                try
                {
                    AzureClient.Initialize(config);
                    break;
                }
                catch (SiloUnavailableException e)
                {
                    attempt++;
                    if (attempt &gt;= initializeAttemptsBeforeFailing)
                    {
                         throw;
                    }
                    Thread.Sleep(TimeSpan.FromSeconds(2));
                }
            }
              ...
</code></pre><p>Repeated calls to <code>AzureClient.Initialize()</code>  will return and do nothing if the Orleans client connection is already set up.</p>
<p>An additional variant of <code>AzureClient.Initialize(System.IO.FileInfo)</code> allows a base client config file location to be specified explicitly.
The internal endpoint addresses of the Orleans silo nodes will still be determined dynamically from the Orleans Silo instance table each silo node registers with.</p>
<!--TODO: Create link to Orleans API when the link is created/found-->
<p>See the Orleans API docs for details of the various <code>Initialize</code> methods available.</p>
<h2 id="deploying-to-azure">Deploying to Azure</h2>
<p>The normal Azure deployment tools are used to deploy the application to Windows Azure – either into the local Azure Compute Emulator for local development / test (Press F5 to run), or into the Azure cloud hosting environment right click on the Cloud project and select &#39;Publish&#39;:</p>
<h2 id="next">Next</h2>
<p>We&#39;ll write our own storage provider, to save grain state to alternative to file instead of Microsoft Azure:</p>
<p><a href="Custom-Storage-Providers.html">Custom Storage Providers</a></p>

            </article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/dotnet/orleans/blob/gh-pages/src/Tutorials/Cloud-Deployment.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2015-2016 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
