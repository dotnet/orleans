<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Dependency Injection | Microsoft Orleans Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Dependency Injection | Microsoft Orleans Documentation ">
    <meta name="generator" content="docfx 2">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../Images/logo-light.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="what-is-dependency-injection">What is Dependency Injection</h1>

<p>Dependency injection (DI) is a technique for achieving loose coupling between objects and their collaborators, or dependencies.
Rather than directly instantiating collaborators, or using static references, the objects a class needs in order to perform its actions are provided to the class in some fashion. Most often, classes will declare their dependencies via their constructor, allowing them to follow the <a href="http://deviq.com/explicit-dependencies-principle/">Explicit Dependencies Principle</a>. This approach is known as &quot;constructor injection&quot;.</p>
<h1 id="di-in-orleans">DI in Orleans</h1>
<p>Dependency Injection is currently supported on both silo side and client side. </p>
<p>By integrating Orleans with dependency injection, now it is possible to inject dependencies into application Grains, providers, and other extension points of orleans. </p>
<p>Orleans uses the DI abstraction created for <a href="https://docs.asp.net">ASP.NET Core</a>.
For a detailed explanation about how it works, check out the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection">official documentation</a>.</p>
<h1 id="configuring-di">Configuring DI</h1>
<p>DI for silos and client is configured through <code>SiloHostBuilder</code> and <code>ClientBuilder</code> respectively.
For example, to configure DI on the silo side with a <code>IInjectedService</code> singleton, whose declaration and implementation as below, </p>
<pre><code class="lang-csharp">public interface IInjectedService
{
    Task&lt;long&gt; GetTicks();
}

public class InjectedService : IInjectedService
{
    public Task&lt;long&gt; GetTicks()
    {
        return Task.FromResult(DateTime.UtcNow.Ticks);
    }
}
</code></pre><p>you register it through <code>SiloHostBuilder</code>:</p>
<pre><code class="lang-csharp">var siloBuilder = new SiloHostBuilder();
//configure silo DI with a IInjectedService using a Action&lt;IServiceCollection&gt; delegate.
siloBuilder.ConfigureServices(svc=&gt;svc.AddSingleton&lt;IInjectedService,InjectedService&gt;());
</code></pre><p>On the client side, you do the same via <code>ClientBuilder</code>:</p>
<pre><code class="lang-csharp">var clientBuilder = new ClientBuilder();
//configure client DI with a IInjectedService using a Action&lt;IServiceCollection&gt; delegate.
clientBuilder.ConfigureServices(svc=&gt;svc.AddSingleton&lt;IInjectedService,InjectedService&gt;());
</code></pre><p>This example shows how a Grain can inject <code>IInjectedService</code> via constructor injection:</p>
<pre><code class="lang-csharp">public interface ISimpleDIGrain : IGrainWithIntegerKey
{
    Task&lt;long&gt; GetTicksFromService();
}

public class SimpleDIGrain : Grain, ISimpleDIGrain
{
    private readonly IInjectedService injectedService;

    public SimpleDIGrain(IInjectedService injectedService)
    {
        this.injectedService = injectedService;
    }

    public Task&lt;long&gt; GetTicksFromService()
    {
        return injectedService.GetTicks();
    }
}
</code></pre><h1 id="test-framework-integration">Test Framework Integration</h1>
<p>DI truly shines when coupled with a testing framework.</p>
<p>One popular use of DI is to mock services.
In order to set up mocked service with your test cluster, you need to do two things.
First, you need to implement mocks of your services.
This is done in our example using <a href="https://github.com/moq/">Moq</a>, a popular mocking framework for .NET.
Here is an example of mocking a service and inject the mocked service into DI.</p>
<pre><code class="lang-csharp">public class MockServices
{
    public static void ConfigureMockServices(IServiceCollection services)
    {
        var mockInjectedService = new Mock&lt;IInjectedService&gt;();

        mockInjectedService.Setup(t =&gt; t.GetTicks()).Returns(knownDateTime);
        services.AddSingleton&lt;IInjectedService&gt;(mockInjectedService.Object);
    }
}
</code></pre><p>Now, to include these services in your test cluster, you need to configure mocked services with <code>TestClusterBuilder</code>.
Here is an example of how to configure DI with mocked services on both silo and client side.</p>
<pre><code class="lang-csharp">[TestClass]
public class IInjectedServiceTests
{
    private readonly TestCluster hostedCluster;

    [TestInitialize]
    public void Setup()
    {
        if (hostedCluster == null)
        {
             var builder = new TestClusterBuilder();
             //use ISiloBuilderConfigurator to configure ISiloHostBuilder, and add the configurator to TestClusterBuilder, 
             //so the configuration will be applied to silos when test cluster build ISiloHostBuilder and starts the silos.
             builder.AddSiloBuilderConfigurator&lt;MySiloBuilderConfigurator&gt;();
             //use IClientBuilderConfigurator to configure IClientBuilder, and add the configurator to TestClusterBuilder,
             //so the configuration would be applied when test clusetr builder IClientBuilder start the client.
             builder.AddClientBuilderConfigurator&lt;MyClientBuilderConfigurator&gt;();

            //builde the test cluster
            var testCluster = builder.Build();
            //deploy test cluster
            testCluster.Deploy();
            this.hostedCluster = testCluster;
        }
    }

    private class MySiloBuilderConfigurator : ISiloBuilderConfigurator
    {
        public void Configure(ISiloHostBuilder hostBuilder)
        {
            //configure silo side DI with mock services
            hostBuilder.ConfigureServices(MockServices.ConfigureMockServices);
        }
    }

    private class MyClientBuilderConfigurator : IClientBuilderConfigurator
    {
        public void Configure(IConfiguration configuration, IClientBuilder clientBuilder)
        {
            //configure client side DI with mock services
            clientBuilder.ConfigureServices(MockServices.ConfigureMockServices);
        }
    }
}
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
