<Project>

  <PropertyGroup>
    <!-- Frontend paths -->
    <NpmAppRootDirectory>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)\..\Orleans.Dashboard.App'))</NpmAppRootDirectory>
    <NpmBuildOutput>$([System.IO.Path]::GetFullPath('$(NpmAppRootDirectory)\dist\'))</NpmBuildOutput>
    <AzureDevOpsNpmrcFile>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)\.azdo\.npmrc'))</AzureDevOpsNpmrcFile>
  </PropertyGroup>

  <!-- Collect frontend source files for incremental build tracking -->
  <ItemGroup>
    <NpmAppSources Include="$(NpmAppRootDirectory)\src\**\*" />
    <NpmAppSources Include="$(NpmAppRootDirectory)\public\**\*" />
    <NpmAppSources Include="$(NpmAppRootDirectory)\package.json" />
    <NpmAppSources Include="$(NpmAppRootDirectory)\vite.config.ts" />
    <NpmAppSources Include="$(NpmAppRootDirectory)\tsconfig.json" />
    <NpmAppSources Include="$(NpmAppRootDirectory)\index.html" />
  </ItemGroup>

  <!-- Use a marker file for incremental build tracking -->
  <PropertyGroup>
    <NpmAppBuildMarker>$(BaseIntermediateOutputPath)\frontend.build.marker</NpmAppBuildMarker>
  </PropertyGroup>

  <Target
    Name="DeleteNpmBuildMarker"
    AfterTargets="Clean"
    Condition="Exists($(NpmAppBuildMarker))">
    <Delete Files="$(NpmAppBuildMarker)" />
  </Target>

  <!-- Build the frontend (runs once regardless of target frameworks)
       See: https://learn.microsoft.com/visualstudio/msbuild/run-target-exactly-once -->
  <Target Name="BuildNpmApp" Inputs="@(NpmAppSources)" Outputs="$(NpmAppBuildMarker)">
    <!-- Use Azure DevOps npmrc and build command if running in CI, otherwise use defaults -->
    <PropertyGroup>
      <NpmConfigArg Condition="'$(TF_BUILD)' == 'true'">--userconfig &quot;$(AzureDevOpsNpmrcFile)&quot;</NpmConfigArg>
      <NpmBuildCommand>build</NpmBuildCommand>
    </PropertyGroup>
    <Exec
      Command="npm ci --prefer-offline --no-audit $(NpmConfigArg)"
      WorkingDirectory="$(NpmAppRootDirectory)"
      ConsoleToMsBuild="true" />
    <Exec
      Command="npm run $(NpmBuildCommand)"
      WorkingDirectory="$(NpmAppRootDirectory)"
      ConsoleToMsBuild="true" />
    <!-- Create marker file to track successful build -->
    <Touch Files="$(NpmAppBuildMarker)" AlwaysCreate="true" />
  </Target>

  <!-- Hook BuildNpmApp to run once before DispatchToInnerBuilds for multi-targeted builds -->
  <Target
    Name="BuildNpmAppBeforeOuterBuild"
    DependsOnTargets="BuildNpmApp"
    BeforeTargets="DispatchToInnerBuilds"
    />

  <!-- Hook BuildNpmApp to run once before inner build targets (invokes outer build) -->
  <Target
    Name="BuildNpmAppBeforeInnerBuild"
    BeforeTargets="AssignTargetPaths;BeforeBuild;Compile">
    <MSBuild
      Projects="$(MSBuildProjectFullPath)"
      Targets="BuildNpmApp"
      RemoveProperties="TargetFramework" />
  </Target>

  <!-- Include frontend assets as embedded resources -->
  <ItemGroup>
    <EmbeddedResource
      Include="$(NpmBuildOutput)\**\*"
      Condition="Exists('$(NpmBuildOutput)')"
      Link="wwwroot\%(RecursiveDir)%(Filename)%(Extension)"
      />
  </ItemGroup>

  <!-- Verify required frontend assets are present -->
  <Target Name="ValidateFrontendAssets" BeforeTargets="CoreCompile" DependsOnTargets="BuildNpmApp">
    <ItemGroup>
      <RequiredAsset Include="$(NpmBuildOutput)\index.html" />
      <RequiredAsset Include="$(NpmBuildOutput)\index.min.js" />
      <MissingAsset Include="@(RequiredAsset)" Condition="!Exists('%(Identity)')" />
    </ItemGroup>

    <Error Condition="'@(MissingAsset)' != ''" Text="Required frontend assets are missing: @(MissingAsset, ', '). Frontend build may have failed." />
  </Target>

</Project>
